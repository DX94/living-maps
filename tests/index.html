<html>
  <head>
    <style>
      html, body {
        padding: 0; margin: 0; height: 100%;
        background-color: black;
      }
    </style>
  </head>

  <body>
    <canvas id="c"></canvas>
  </body>

  <script src="d3.min.js"></script>

  <script>
    // canvas init
    var canvas = document.getElementById('c');
    var w = canvas.width = innerWidth;
    var h = canvas.height = innerHeight;
    var ctx = canvas.getContext('2d');
    ctx.translate(w>>1, h>>1);


    // mercator with canvas size
    var projection = d3.geo.mercator()
      .scale((w+ 1) / 2 / Math.PI)
      .translate([w/2, h/2])
      .precision(.0001);

      var center = projection(
        [40.40973495735627, -3.681693843701168 ] // madrid
      //[51.511214,  -0.100824] // london
      );
    var scale = 1500;

    // projects to canvas coordinate system [lat, lon] => [x, y]
    function _p(point) {
        point = projection([point[1], point[0]]);
        return [
            -scale*(point[1] - center[1]),
            -scale*(point[0] - center[0])]
    }

    //d3.json('http://pulsemaps.cartodb.com/api/v2/sql?q=select * from london_fake&format=geojson', function(data) {
    //d3.json('http://javi.cartodb.com/api/v2/sql?q=select * from map_line&format=geojson', function(data) {
    d3.json("http://viz2.cartodb.com/api/v2/sql?q=SELECT * FROM madrid_osm_line_copy where st_distance(the_geom, st_geomfromtext('POINT(-3.681693843701168 40.40973495735627)', 4326)) < 0.05  AND st_length(the_geom) > 0.01 &format=geojson", function(data) {

      for(var i = 0; i < data.features.length; ++i) {
        var coords = data.features[i].geometry.coordinates[0];

        for(var c = 0; c < coords.length - 1 ; ++c) {
          var p0 = _p(coords[c])
          var p1 = _p(coords[c + 1])
          var dx = p1[0] - p0[0];
          var dy = p1[1] - p0[1];
          var len = Math.sqrt(dx*dx + dy*dy);
          coords[c].dir = [dx/len, dy/len];
          coords[c].r = [];
          var offset = (40*Math.random()) >> 0;
          for(var t = 0; t < 100; ++t) {
            coords[c].r[t] = 3 + 7*(1 + Math.cos(5*((offset + t+c)/10.0)));//15*Math.random();
          }
        }

        coords[coords.length - 1].dir = [0, 0]
        coords[coords.length - 1].r = [];
        for(var t = 0; t < 100; ++t) {
            coords[coords.length - 1].r[t] = 5 + 10*(1 + Math.cos(5*((t+c)/10.0)));//15*Math.random();
        }

      }
      var render = function(coords, DD, t) {
        ctx.lineWidth = 1;
        var p0 = _p(coords[0]);
        ctx.moveTo(p0[0], p0[1]);

        for(var cc = 0; cc < coords.length*2 - 2; ++cc) {
          var c = cc;
          var D = DD;
          if(cc >= coords.length - 1) {
            c = 2*coords.length - 2 - c;
            D = -DD;
          }
          var c1 = coords[c];
          var p1 = _p(c1);
          var d1 = c1.sdir;

          var C = 5;
          var pd1 = [c1.dir[1], -c1.dir[0]]

          var p1_a = [
           p1[0] + D*c1.r[t]*pd1[0],
           p1[1] + D*c1.r[t]*pd1[1]
          ]

          ctx.lineTo(p1_a[0], p1_a[1]);
        }
      }
      var frame = function(fn) { setTimeout(fn, 20); }

      var t = 0;
      function loop() {
        canvas.width = w;
        ctx.translate(w>>1, h>>1);
        ctx.globalCompositeOperation = 'lighter'
        for(var i = 0; i < data.features.length; ++i) {
          var coords = data.features[i].geometry.coordinates[0];
          ctx.beginPath();
          ctx.fillStyle = 'rgba(0, 49, 100, 0.5)';// ' + alpha + ')';
          render(coords, 0.3, t%100);
          ctx.fill();
          //ctx.stroke();

        }
        frame(loop);
        ++t;
      }
      frame(loop);
    });


    /*
        */





  </script>
</html>
