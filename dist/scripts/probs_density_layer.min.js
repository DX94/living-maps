function meterToPixels(a,b,c){var d=initialResolution/(1<<c),e=(a+originShift)/d,f=(b+originShift)/d;return[e,f]}function tilePixelToPixel(a,b,c,d,e){var f=initialResolution/(1<<c),g=256*f,h=-originShift+a*g+d*f,i=originShift-b*g-(256-e)*f,j=(h+originShift)/f<<0,k=(i+originShift)/f<<0;return[j,k]}var originShift=6378137*2*Math.PI/2,initialResolution=6378137*2*Math.PI/256,StreetLayer=L.CanvasLayer.extend({options:{user:"pulsemaps",table:"london_2m_1mm",column:"mm",countby:"sqrt(avg(ac))",resolution:1,step:1,decimate:get_debug_param("decimation",3),start_date:1,end_date:1419,time_offset:0,use_web_worker:!0,num_web_workers:3,reduction:0},initialize:function(a){if(_.extend(this.options,a),L.CanvasLayer.prototype.initialize.call(this),this.on("tileAdded",function(a){this.getProbsData(a,a.zoom)},this),this._render=this._render1,this.pre_cache_data=this.pre_cache_data1,this.options.steps=this.options.end_date-this.options.start_date,this.MAX_UNITS=0|this.options.steps+2,this.force_map={},this.time=0,this.sprites=[],this.totalBytes=0,this.render_options={part_min_size:5,part_inc:29,part_color:[255,255,255,1],min_alpha:.22,alpha_inc:.5,exp_decay:9,post_process:!1,post_size:512,post_alpha:.15,post_decay:.07,filtered:!1,part_type:"glow"},this.options.use_web_worker){this.workers=[];for(var b=0;b<this.options.num_web_workers;++b)this.workers.push(new Worker("scripts/process_tile_worker.js"));this._web_workers_callbacks={}}this.precache_sprites=this.precache_sprites.bind(this),this.precache_sprites()},setCity:function(a,b,c){this.options.table=a+"_live",this.options.time_offset=b,this.options.reduction=c},_onMapMove:function(){var a=this;requestAnimationFrame(function(){a._renderSteets(),a._render()})},_renderSteets:function(){var a=this._map._getNewTopLeftPoint(this._map.getCenter(),this._map.getZoom()),b=this._streetsLayer;this._streetsLayer.width=this._streetsLayer.width,this._streetsLayerCtx.fillStyle="rgba(0, 0, 0, 0)",this._streetsLayerCtx.fillRect(0,0,b.width,b.height),this._streetsLayerCtx.translate(-a.x,-a.y),this._streetsLayerCtx.globalAlpha=.75;for(var c in this._tiles){var d=this._tiles[c],e=this._getTilePos(d.coord);this._streetsLayerCtx.drawImage(d.img,e.x,e.y)}},precache_sprites:function(){this.sprites=[];for(var a=this.render_options,b=function(b,c){return b>>=0,Sprites.render_to_canvas(function(d){var e=a.part_color;"sphere"==a.part_type?Sprites.circle(d,b,[e[0],e[1],e[2],255*c]):Sprites.draw_circle_glow_iso(d,b,[e[0],e[1],e[2],255*c],a.exp_decay)},b,b)},c=0;7>c;++c)this.sprites.push(b(a.part_min_size+c*a.part_inc,a.min_alpha+a.alpha_inc*c))},set_time:function(a){a+=60*this.options.time_offset,a=fmod(a,60*this.options.end_date),this.time=a/60>>0,this.time=this.time/this.options.decimate>>0},onAdd:function(a){a.on("move reset",this._onMapMove,this),L.CanvasLayer.prototype.onAdd.call(this,a);var b=this._map._getNewTopLeftPoint(this._map.getCenter(),this._map.getZoom());this._ctx.translate(-b.x,-b.y),this._ctx.globalCompositeOperation="lighter",this._streetsLayer=this.addCanvasLayer(),this._streetsLayerCtx=this._streetsLayer.getContext("2d"),this._streetsLayer.style.zIndex=50,this._streetsLayerCtx.translate(-b.x,-b.y)},tile:function(a,b,c,d){var e=this,f="http://pulsemaps.cartodb.com/",g=f+"api/v2/sql?q="+encodeURIComponent(a);if(this.options.use_web_worker){var h=this.workers[(c.x+c.y+d)%this.workers.length],i=[c.x,c.y,d].join("/");this._web_workers_callbacks[i]=b;var j=function(a){a=a.data;var b=a.coord,c=[b.x,b.y,b.z].join("/"),d=e._web_workers_callbacks[c];d&&(console.log("<-",c),delete e._web_workers_callbacks[c],d(a))};h.addEventListener("message",j,!1),console.log("->",i),h.postMessage(JSON.stringify({url:g,coord:{x:c.x,y:c.y,z:d},TIME_SLOTS:this.MAX_UNITS}))}else{var k=Profiler.get("tile fetching").start(),l="";if(-1!=location.search.indexOf("debug"))var l=g+"&format=arraybuffer";else var l=g+"&format=arraybuffer";get(l,function(a){k.end();var c=a.response?a.response.byteLength:0;console.log("tile size: "+(c/1024>>0)+"kb"),Profiler.new_value("tile_size",c/1024>>0),e.totalBytes+=c;var d=null;a.response&&a.response.byteLength&&(d=new ArrayBufferSer(a.response)),b(d),console.log("total size: "+(e.totalBytes/1024>>0)+"kb")})}},pre_cache_data2:function(a,b,c){var d,e=new Int32Array(a.length),f=new Int32Array(a.length),g=new Uint8Array(a.length*this.MAX_UNITS),h=new Uint8Array(a.length*this.MAX_UNITS);Profiler.new_value("tiles mem 2",(8*a.length+3*a.length*this.MAX_UNITS)/1024);var i=Profiler.get("preprocess time 2").start(),j=256<<c;for(var k in a){d=a[k],pixels=tilePixelToPixel(b.x,b.y,c,d.x,d.y),e[k]=pixels[0]>>0,f[k]=j-pixels[1]>>0;for(var l=k*this.MAX_UNITS,m=0;m<d.dates.length;++m)h[l+d.dates[m]]=g[l+d.dates[m]]=a.vals[m];for(var n=2;n--;)for(var m=1;m<this.MAX_UNITS;++m)h[l+m]+=h[l+m-1]/2;for(var m=1;m<this.MAX_UNITS;++m)h[l+m]=Math.min(6,h[l+m])>>0}return i.end(),{count:g,count_filtered:h,x:e,y:f,len:a.length}},pre_cache_data1:function(a,b,c){for(var d=this.MAX_UNITS,e=new Int32Array(d),f=new Int32Array(d),g=new Int32Array(a.length),h=new Int32Array(a.length),i=Profiler.get("preprocess time").start(),j=0,k=0;k<a.get("dates__uint16").length;++k){var l=a.get("dates__uint16")[k];j+=l.length}var m=new Uint8Array(j),n=new Uint32Array(j);Profiler.new_value("tiles mem",(4*2*a.length+4*2*d+5*j)/1024);for(var o=256<<c,p=a.get("x__uint8"),q=a.get("y__uint8"),k=0;k<a.length;++k){var r=tilePixelToPixel(b.x,b.y,c,p[k],q[k]);g[k]=0|r[0],h[k]=0|o-r[1]}for(var s=0,t=0,u=0;d>u;++u){for(var v=0,k=0;k<a.length;++k)for(var j=a.get("dates__uint16")[k],w=a.get("vals__uint8")[k],x=0,y=j.length;y>x;++x)j[x]==u&&(++v,m[s]=w[x],n[s]=k,++s);e[u]=t,f[u]=v,t+=v}return i.end(),{x:g,y:h,timeCount:f,timeIndex:e,renderDataPos:n,renderData:m}},_render1:function(){if(this._canvas){var a=Profiler.get("render").start();this._canvas.width=this._canvas.width;var b=this._map._getNewTopLeftPoint(this._map.getCenter(),this._map.getZoom());this._ctx.translate(-b.x,-b.y),this._ctx.globalCompositeOperation="lighter";var c=this.options.reduction,d=this._ctx,e=this.time;for(var f in this._tiles){var g=this._tiles[f],h=g.timeCount[e];if(h)for(var i=g.timeIndex[e],j=0;h>j;++j){var k=g.renderDataPos[i+j],l=g.renderData[i+j];if(l-c>0){var m=this.sprites[l];d.drawImage(m,g.x[k]-(m.width>>1),g.y[k]-(m.height>>1)+2*l)}}}a.end()}},_render2:function(){if(this._canvas){var a=Profiler.get("render2").start();this._canvas.width=this._canvas.width;var b=this._map._getNewTopLeftPoint(this._map.getCenter(),this._map.getZoom());this._ctx.translate(-b.x,-b.y);var c=this._ctx,d=this.time;for(var e in this._tiles)for(var f=this._tiles[e],g=f.x,h=f.y,i=this.render_options.filtered?f.count_filtered:f.count,j=f.len,k=0;j>k;++k){var l=this.MAX_UNITS*k+d,m=i[l];if(m){var n=this.sprites[m];c.drawImage(n,g[k]-(n.width>>1),h[k]-(n.height>>1)+2*m)}}a.end()}},getProbsData:function(a,b){var c=this,d=encodeURIComponent("SELECT the_geom_webmercator,feat_type as class,null as name,0 as attr2, 'nokia_landusage' as layer FROM london_landuse_nokia UNION ALL SELECT the_geom_webmercator,feat_type as class,null as name, 0 as attr2, 'nokia_landusage' as layer FROM chicago_landuse_nokia UNION ALL SELECT the_geom_webmercator,feat_type as class,null as name,0 as attr2, 'nokia_landusage' as layer FROM helsinki_landuse_nokia UNION ALL SELECT the_geom_webmercator,feat_type as class,null as name,0 as attr2, 'nokia_landusage' as layer FROM mumbai_landuse_nokia UNION ALL SELECT the_geom_webmercator,feat_type as class,null as name,0 as attr2,'nokia_landusage' as layer FROM rome_landuse_nokia UNION ALL SELECT the_geom_webmercator,feat_type as class, polygon_nm as name,0 as attr2, 'nokia_waterareas' as layer FROM london_waterareas_nokia UNION ALL SELECT the_geom_webmercator,feat_type as class, polygon_nm as name,0 as attr2, 'nokia_waterareas' as layer FROM chicago_waterareas_nokia UNION ALL SELECT the_geom_webmercator,feat_type as class, polygon_nm as name,0 as attr2, 'nokia_waterareas' as layer FROM helsinki_waterareas_nokia UNION ALL SELECT the_geom_webmercator,feat_type as class, polygon_nm as name,0 as attr2, 'nokia_waterareas' as layer FROM mumbai_waterareas_nokia UNION ALL SELECT the_geom_webmercator,feat_type as class, polygon_nm as name,0 as attr2, 'nokia_waterareas' as layer FROM rome_waterareas_nokia UNION ALL SELECT the_geom_webmercator,null as class,null as name,fc as att2, 'nokia_fullroads' as layer FROM cities_fullroads_nokia"),e="http://0.tiles.cartocdn.com/pulsemaps/tiles/nokia_basemap/",f="{0}/{1}/{2}.png?sql="+d+"&cache_policy=persist&cache_buster=1",g=new Image,h=e+f.format(b,a.x,a.y);g.src=-1!=location.search.indexOf("debug")?h:h,g.onload=function(){c._renderSteets()};var i="WITH par AS ("+" SELECT CDB_XYZ_Resolution({0}) as res".format(b)+", CDB_XYZ_Extent({0},{1},{2}) as ext ".format(a.x,a.y,b)+"),\ncte AS ( SELECT ST_SnapToGrid(i.the_geom_webmercator, p.res) g"+", {0} c".format(this.options.countby)+", floor(({0}- {1})/{2}) d".format(this.options.column,this.options.start_date,this.options.step)+" FROM {0} i, par p ".format(this.options.table)+"WHERE i.the_geom_webmercator && p.ext "+"AND mm % {0} = 0 AND ac > 1200 ".format(this.options.decimate)+"GROUP BY g, d"+") SELECT least((st_x(g)-st_xmin(p.ext))/p.res, 255) x__uint8, "+"least((st_y(g)-st_ymin(p.ext))/p.res, 255) y__uint8,"+" array_agg(least(6, ceil(c/100))) vals__uint8,"+" array_agg(floor(d/{0})) dates__uint16".format(this.options.decimate)+" FROM cte, par p GROUP BY x__uint8, y__uint8";this.tile(i,function(d){if(c.options.use_web_worker)e=d;else{var e={timeCount:[]};d&&(e=c.pre_cache_data(d,a,b))}e.coord=a,e.img=g,console.log("loaded",a),c._tileLoaded(a,e),c._renderSteets()},a,b)},_onTilesStartLoading:function(){Events.trigger("loading")},_onTilesFinishLoading:function(){Events.trigger("finish_loading")}});