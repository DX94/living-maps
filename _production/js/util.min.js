/*! living-maps 28-05-2013 */
function fmod(a,b){var c=Math.floor(a/b);return a-c*b}function rand(){return 2*(Math.random()-.5)}function get_debug_param(a,b){b=b||0;var c=window.location.href.match(new RegExp(a+"=(\\d+)"));return c&&2==c.length?0|c[1]:b}function vec3(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0,this.translate=function(a){return new vec3(this.x+a[0],this.y+a[1],this.z+a[2])},this.scale=function(a){return new vec3(a*this.x,a*this.y,a*this.z)},this.rotz=function(a){var b=Math.cos(a),c=Math.sin(a);return new vec3(this.x*b-this.y*c,this.y*b+this.x*c,this.z)},this.rotx=function(a){var b=Math.cos(a),c=Math.sin(a);return new vec3(this.x,this.y*b-this.z*c,this.z*b+this.y*c)},this.proj=function(a){return new vec3(this.x*(a/(a-this.z)),this.y*(a/(a-this.z)),1)}}function transform3d(a,b,c){var d=new vec3(a.x,a.y,0);return d=d.translate([-b/2,-c/2,-50]).rotx(45*Math.PI/180).proj(1e3).translate([b/2,c/2,0]),{x:d.x,y:d.y}}function latlonTo3DPixel(a,b){var c=a.latLngToContainerPoint(b),d=a.getSize();return transform3d(c,d.x,d.y)}function isACity(a){var b=!1;return _.each(window.AppData.CITIES,function(c,d){a===d&&(b=!0)}),b}function parseHash(a){var b=a.split("/");if(isACity(b[1])){city=b[1];var c=parseFloat(b[2]).toFixed(3),d=parseFloat(b[3]).toFixed(3),e=parseInt(b[4],10),f=b[5];return isNaN(c)||isNaN(d)||isNaN(e)||e<window.AppData.CITIES[city].map.minZoom||e>window.AppData.CITIES[city].map.maxZoom?(history.pushState(window.AppData.CITIES[city],null,"#cities/"+city),window.AppData.CITIES[city]):((isNaN(f)||f<window.AppData.init_time||f>=window.AppData.last_time)&&(f=0),0===parseInt(f,10)&&history.pushState(null,null,"#cities/"+city+"/"+c+"/"+d+"/"+e+"/"),{city:city,map:{center:[c,d],zoom:e},time_scale:900,scale:2,time:f,time_offset:window.AppData.CITIES[city].time_offset})}return history.pushState(window.AppData.CITIES[city],null,"#cities/"+window.AppData.CITIES[city].city),window.AppData.CITIES[city]}function tilePixelToPixel(a,b,c,d,e){var f=initialResolution/(1<<c),g=256*f,h=-originShift+a*g+d*f,i=originShift-b*g-(256-e)*f,j=(h+originShift)/f<<0,k=(i+originShift)/f<<0;return[j,k]}function updateHash(a,b,c,d){var e="";e="undefined"!=typeof d?d:a.getZoom();var f=parseInt(c/60,10),g=a.getCenter().lat.toFixed(3),h=a.getCenter().lng.toFixed(3),i="#cities/"+b+"/"+g+"/"+h+"/"+e+"/";f!=window.AppData.init_time&&f!=window.AppData.last_time&&(i+=f),history.pushState({city:b,map:{center:[g,h],zoom:e},city_name:window.AppData.CITIES[b].city_name,city_title:window.AppData.CITIES[b].city_title,city_subtitle:window.AppData.CITIES[b].city_subtitle,time_scale:900,scale:2,time:c},null,i)}function goTo(a,b,c){if(a){var d=b&&b.speed||800,e=b&&b.delay||100,f=b&&b.margin||0;$("html, body").delay(e).animate({scrollTop:a.offset().top-f},d),c&&c()}}if("undefined"!=typeof window){var _requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.requestAnimationFrame;window.requestAnimationFrame=_requestAnimationFrame}String.prototype.format=function(a,b,c){function d(){var d=this,e=arguments.length+1;for(a=0;e>a;c=arguments[a++])b="object"==typeof c?JSON.stringify(c):c,d=d.replace(RegExp("\\{"+(a-1)+"\\}","g"),b);return d}return d}();var originShift=6378137*2*Math.PI/2,initialResolution=6378137*2*Math.PI/256;